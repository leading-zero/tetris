const canvas=document.getElementById("tetris"),context=canvas.getContext("2d");function arenaSweep(){let e=1;e:for(let r=arena.length-1;r>0;--r){for(let e=0;e<arena[r].length;++e)if(0===arena[r][e])continue e;const t=arena.splice(r,1)[0].fill(0);arena.unshift(t),++r,player.score+=10*e,e*=2}}function collide(e,r){const[t,a]=[r.matrix,r.pos];for(let r=0;r<t.length;++r)for(let o=0;o<t[r].length;++o)if(0!==t[r][o]&&0!==(e[r+a.y]&&e[r+a.y][o+a.x]))return!0;return!1}function createMatrix(e,r){const t=[];for(;r--;)t.push(new Array(e).fill(0));return t}function createPiece(e){return"T"===e?[[0,0,0],[1,1,1],[0,1,0]]:"O"===e?[[2,2],[2,2]]:"L"===e?[[0,3,0],[0,3,0],[0,3,3]]:"J"===e?[[0,4,0],[0,4,0],[4,4,0]]:"I"===e?[[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]]:"S"===e?[[0,6,6],[6,6,0],[0,0,0]]:"Z"===e?[[7,7,0],[0,7,7],[0,0,0]]:void 0}function draw(){context.fillStyle="#000",context.fillRect(0,0,canvas.width,canvas.height),drawMatrix(arena,{x:0,y:0}),drawMatrix(player.matrix,player.pos)}function drawMatrix(e,r){e.forEach((e,t)=>{e.forEach((e,a)=>{0!==e&&(context.fillStyle=colors[e],context.fillRect(a+r.x,t+r.y,.9,.9))})})}function merge(e,r){r.matrix.forEach((t,a)=>{t.forEach((t,o)=>{0!==t&&(e[a+r.pos.y][o+r.pos.x]=t)})})}function playerDrop(){player.pos.y++,collide(arena,player)&&(player.pos.y--,merge(arena,player),playerReset(),arenaSweep(),updateScore()),dropCounter=0}function playerMove(e){player.pos.x+=e,collide(arena,player)&&(player.pos.x-=e)}function playerReset(){player.matrix=createPiece("ILJOTSZ"["ILJOTSZ".length*Math.random()|0]),player.pos.y=0,player.pos.x=(arena[0].length/2|0)-(player.matrix[0].length/2|0),collide(arena,player)&&(arena.forEach(e=>e.fill(0)),player.score=0,updateScore())}function playerRotate(e){const r=player.pos.x;let t=1;for(rotate(player.matrix,e);collide(arena,player);)if(player.pos.x+=t,(t=-(t+(t>0?1:-1)))>player.matrix[0].length)return rotate(player.matrix,-e),void(player.pos.x=r)}function rotate(e,r){for(let r=0;r<e.length;++r)for(let t=0;t<r;++t)[e[t][r],e[r][t]]=[e[r][t],e[t][r]];r>0?e.forEach(e=>e.reverse()):e.reverse()}context.scale(20,20);let dropCounter=0,dropInterval=1e3,lastTime=0;function update(e=0){const r=e-lastTime;lastTime=e,(dropCounter+=r)>dropInterval&&playerDrop(),draw(),requestAnimationFrame(update)}function updateScore(){document.getElementById("score").innerText=player.score}const colors=[null,"#FF0D72","#0DC2FF","#0DFF72","#F538FF","#FF8E0D","#FFE138","#3877FF","#3877FF"],arena=createMatrix(12,20),player={pos:{x:0,y:0},matrix:null,score:0};document.addEventListener("keydown",e=>{"ArrowLeft"===e.key?playerMove(-1):"ArrowRight"===e.key?playerMove(1):"ArrowDown"===e.key?playerDrop():"ArrowUp"===e.key&&playerRotate(-1)}),playerReset(),updateScore(),update();